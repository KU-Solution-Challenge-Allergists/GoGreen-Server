
name: Deploy to Google Cloud Run

on:
  push:
    branches:
      - "development"

permissions:
  contents: read

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    environment: development

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Create .env file
        run: |
          # copy all secrets from github secrets, and create .dev.env file
          jq -r 'to_entries|map("\(.key)=\(.value|tostring)")|.[]' <<< "$SECRETS_CONTEXT" > .dev.env
        env:
          SECRETS_CONTEXT: ${{ toJson(secrets) }}

      - name: Setup GCP Service Account
        uses: GoogleCloudPlatform/github-actions/setup-gcloud@master
        with:
          version: 'latest'
          service_account_email: ${{ secrets.FIREBASE_CLIENT_EMAIL }}
          service_account_key: ${{ secrets.FIREBASE_PRIVATE_KEY }}
          export_default_credentials: true

      - name: Configure Docker
        run: |
          gcloud auth configure-docker

      - name: Build and push image to Google Container Registry
        env:
          REGISTRY_NAME: ${{ secrets.REGISTRY_NAME }}
          PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          IMAGE_TAG: ${{ secrets.CONTAINER_TAG }}
        run: |
          docker build -f dev.dockerfile -t gcr.io/$PROJECT_ID/$REGISTRY_NAME:$IMAGE_TAG .
          docker push gcr.io/$PROJECT_ID/$REGISTRY_NAME:$IMAGE_TAG

      - name: Deploy To Google Cloud Run
        env:
          REGISTRY_NAME: ${{ secrets.REGISTRY_NAME }}
          PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          IMAGE_TAG: ${{ secrets.CONTAINER_TAG }}
        run: |
          gcloud run deploy $REGISTRY_NAME \
          --region asia-northeast3 \
          --image gcr.io/$PROJECT_ID/REGISTRY_NAME \
          --platform managed \
          --allow-unauthenticated \
          --project $PROJECT_ID
